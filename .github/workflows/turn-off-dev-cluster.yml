name: "Turn off the K8s dev cluster"
on:
  workflow_dispatch:
  schedule:
  - cron: "0 18 * * *"    # minute (0-59) | hour(0-23) | day of the month(1-31) | month(1-12) | day of the week(1-7)
                          # Uses UTC timezone - Run every day at 20:00 CET -> "0 18 * * *"
jobs:
  turn-off:
    if: github.event.pull_request.draft == false
    runs-on: self-hosted
    steps:
      # Checkout the repository
      - name: Checkout
        uses: actions/checkout@v2
      - name: install kubectl
        uses: azure/setup-kubectl@v2.0
        with:
          version: latest
      # Setup gcloud CLI
      - uses: google-github-actions/setup-gcloud@v0.6.0
        with:
          service_account_key: ${{ secrets.GKE_SERVICE_ACC_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true
          cleanup_credentials: true
      # Get the GKE credentials so we can deploy to the cluster
      - uses: google-github-actions/get-gke-credentials@v0.2.1
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
          location: ${{ secrets.GKE_ZONE }}
          credentials: ${{ secrets.GKE_SERVICE_ACC_KEY }}
          use_auth_provider: true
      # Turn off the services    
      - name: Turn off the Scheduler
        if: ${{ always() }}   
        run: kubectl scale --replicas=0 deployments/scheduler --namespace=claudie
      - name: Turn off the Builder
        if: ${{ always() }}   
        run: kubectl scale --replicas=0 deployments/builder --namespace=claudie
      - name: Turn off the Terraformer
        if: ${{ always() }}   
        run: kubectl scale --replicas=0 deployments/terraformer --namespace=claudie
      - name: Turn off the Contex-box
        if: ${{ always() }}   
        run: kubectl scale --replicas=0 deployments/context-box --namespace=claudie
      - name: Turn off the Database
        if: ${{ always() }}   
        run: kubectl scale --replicas=0 deployments/mongodb --namespace=claudie
      - name: Turn off the Kube-eleven
        if: ${{ always() }}       
        run: kubectl scale --replicas=0 deployments/kube-eleven --namespace=claudie
      - name: Turn off the Wireguardian
        if: ${{ always() }}   
        run: kubectl scale --replicas=0 deployments/wireguardian --namespace=claudie
