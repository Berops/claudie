name: CI pipeline for creating the docker images via docker-compose
# Controls when the action will run. 
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master, feature/GithubActions ] 
  pull_request:
    branches: [ master ]

jobs:
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
      # Path to env file
    env:
      ENV_FILE: .env
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      # Import .env file
      - name: Import environment variables from a file
        id: import-env
        shell: bash
        run: |
          while read line; do
            echo "$line" >> $GITHUB_ENV
          done < ${{ env.ENV_FILE }}

      # Build the docker images
      - name: Build the docker image for Context-box
        run: docker build --tag context-box -f ./services/context-box/Dockerfile .
      - name: Build the docker image for Scheduler
        run: docker build --tag scheduler -f ./services/scheduler/Dockerfile .
#     - name: Build the docker image for KubeEleven
#       run: docker build --tag kube_eleven -f ./services/kubeEleven/Dockerfile .
#     - name: Build the docker image for Builder
#       run: docker build --tag builder -f ./services/builder/Dockerfile
#     - name: Build the docker image for Wireguardian
#       run: docker build --tag wireguardian -f ./services/wireguardian/Dockerfile .
#     - name: Build the docker image for Terraformer
#       run: docker build --tag terraformer -f ./services/terraformer/Dockerfile .

      # Run the docker images
      - name: Run MongoDB
        run: docker run --rm -it -v mongodb:/data/db --name mongodb -d -p $DATABASE_PORT:$DATABASE_PORT mongo
      - name: Run Context-box
        run: docker run --rm --env-file .env --name context-box -d -p $CONTEXT_BOX_PORT:$CONTEXT_BOX_PORT context-box
      - name: Run Scheduler
        run: docker run --rm --env-file .env --name scheduler -d scheduler
#     - name: Run KubeEleven
#      run: docker run --rm --env-file .env kube_eleven -p ${{KUBE_ELEVEN_PORT}}:${{KUBE_ELEVEN_PORT}}
#     - name: Run Builder
#      run: docker run --rm --env-file .env builder -p ${{BUILDER_PORT}}:${{BUILDER_PORT}}
#     - name: Run Wireguardian
#      run: docker run --rm --env-file .env wireguardian -p ${{WIREGUARDIAN_PORT}}:${{WIREGUARDIAN_PORT}}
#     - name: Terraformer
#      run: docker run --rm --env-file .env terraformer -p ${{TERRAFORMER_PORT}}:${{TERRAFORMER_PORT}}
      - name: Small delay
        run: sleep 5
      # Check if containers are running
      - name: Check the running containers
        run: docker ps -a
      # Show logs from containers
      - name: Show logs from context-box
        run: docker logs context-box
      - name: Show logs from scheduler
        run: docker logs scheduler
 
        