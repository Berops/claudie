name: CD pipeline for platform - dev
# Controls when the action will run. 
on:
  # Run after CI
  workflow_run:
    workflows: [ "CI pipeline for platform" ] # for testing
    types: [ completed ]
  # Manual trigger    
  workflow_dispatch:

jobs:
# Deploy manifests to GKE cluster
  deploy:
    runs-on: ubuntu-latest
    env:
      ARRAY: context-box, scheduler, builder, terraformer, wireguardian #, kube-eleven)
    steps:
      # Checkout the repository
      - name: Checkout
        uses: actions/checkout@v2
       # Retrieve saved tag 
      - name: Get the newest tags
        run: echo "Retrieving saved tags"

      - uses: aaimio/get-persistent-value@v1
        id: get_persistent_value-context-box
        with:
          key: context-box
          access_token: ${{ secrets.PERSISTENT_STORAGE_KEY }}
      - uses: aaimio/get-persistent-value@v1
        id: get_persistent_value-scheduler
        with:
          key: scheduler
          access_token: ${{ secrets.PERSISTENT_STORAGE_KEY }}
      - uses: aaimio/get-persistent-value@v1
        id: get_persistent_value-builder
        with:
          key: builder
          access_token: ${{ secrets.PERSISTENT_STORAGE_KEY }}
      - uses: aaimio/get-persistent-value@v1
        id: get_persistent_value-terraformer
        with:
          key: terraformer
          access_token: ${{ secrets.PERSISTENT_STORAGE_KEY }}
      - uses: aaimio/get-persistent-value@v1
        id: get_persistent_value-wireguardian
        with:
          key: wireguardian
          access_token: ${{ secrets.PERSISTENT_STORAGE_KEY }}
#      - uses: aaimio/get-persistent-value@v1
#        id: get_persistent_value-kube-eleven
#        with:
#          key: kube-eleven
#          access_token: ${{ secrets.PERSISTENT_STORAGE_KEY }}

      # Setup gcloud CLI
      - uses: google-github-actions/setup-gcloud@master
        with:
          service_account_key: ${{ secrets.GKE_SERVICE_ACC_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      # Get the GKE credentials so we can deploy to the cluster
      - uses: google-github-actions/get-gke-credentials@v0.2.1
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
          location: ${{ secrets.GKE_ZONE }}
          credentials: ${{ secrets.GKE_SERVICE_ACC_KEY }}
      # Set the new image tags
      - name: Change the service images to most recent ones
        # Set the working directory
        working-directory: ./K8s-dev-cluster
        run: |
          arr=(${{ env.ARRAY }})

          for SERVICE in "${arr[@]}"
          do
          kustomize edit set image $SERVICE:${{ steps.get_persistent_value-$SERVICE.outputs.value }}
          done
          
          cat kustomization.yaml
      # Deploy to a dev cluster
      - name: Deploy to the dev cluster via kustomize
        # Set the working directory
        working-directory: ./K8s-dev-cluster
        run: kustomize build | kubectl apply -f -
