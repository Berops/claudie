---
- hosts: control
  gather_facts: true
  become: true
  remote_user: root
  tasks:
    - name: remove old apiserver.crt, apiserver.key and /etc/kubernetes/*.conf
      file:
        path: "{{ item }}"
        state: absent
      loop: 
      - "/etc/kubernetes/pki/apiserver.crt"
      - "/etc/kubernetes/pki/apiserver.key"
      - "/etc/kubernetes/admin.conf"
      - "/etc/kubernetes/controller-manager.conf"
      - "/etc/kubernetes/kubelet.conf"
      - "/etc/kubernetes/scheduler.conf"

    - name: find file that contains the hostname 
      find:
        contains: ".*{{ansible_hostname}}.*"
        path: /root/kubeone/cfg/
      register: file
    - name: replace endpoint 
      replace:
        path: "{{file.files[0].path}}"
        regexp: '{{ OldEndpoint}}'
        replace: '{{ NewEndpoint}}'
    - name: generate new certs
      shell: "kubeadm init phase certs apiserver --config {{file.files[0].path}}"
    - name: generate kubeconfig 
      shell: "kubeadm init phase kubeconfig all --config {{file.files[0].path}}"
    - name: upload config map
      shell: "kubeadm init phase upload-config all --config {{file.files[0].path}}"
    - name: restart docker and kubelet
      service:
        name: "{{item}}"
        state: restarted
      become: true
      loop:
        - kubelet
        - docker

- hosts: compute
  gather_facts: true
  become: true
  remote_user: root
  tasks:
    - name: replace endpoint 
      replace:
        path: "/etc/kubernetes/kubelet.conf"
        regexp: '{{ OldEndpoint}}'
        replace: '{{ NewEndpoint}}'
    - name: restart kubelet
      service:
        name: kubelet
        state: restarted
      become: true
